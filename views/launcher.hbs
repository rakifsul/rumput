<div class="mb-3">
    <button class="btn btn-dark w-100" data-bs-toggle="modal" data-bs-target="#itemModal">
        <i class="bi bi-plus-lg"></i> Add Link
    </button>
</div>

<div class="row g-4" id="dashboardGrid">
    {{#each launcher}}
    <div class="col-6 col-md-3 col-lg-2 dashboard-card" id="{{this.id}}" data-title="{{this.title}}"
        data-link="{{this.url}}" data-icon="{{this.icon}}" draggable="true" ondragstart="dragstartHandler(event)"
        ondrop="dropHandler(event)" ondragover="dragoverHandler(event)">
        <a href="{{this.url}}" class="text-decoration-none">
            <div class="card text-center h-100 border-0 shadow-sm">
                <div class="card-body">
                    <i class="display-4 text-danger">{{this.icon}}</i>
                    <h6 class="mt-3 text-dark">{{this.title}}</h6>
                </div>
            </div>
        </a>
    </div>
    {{!-- <div class="col-6 col-md-3 col-lg-2 dashboard-card" data-title="{{this.title}}" data-link="{{this.url}}"
        data-icon="{{this.icon}}">
        <a href="{{this.url}}" class="text-decoration-none">
            <div class="card text-center h-100 border-0 shadow-sm">
                <div class="card-body">
                    <i class="display-4 text-danger">{{this.icon}}</i>
                    <h6 class="mt-3 text-dark">{{this.title}}</h6>
                </div>
            </div>
        </a>
    </div> --}}
    {{/each}}
</div>

<!-- Modal Tambah/Edit -->
<div class="modal fade" id="itemModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form id="itemForm" class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add / Edit Icon</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <input type="hidden" id="editIndex">
                <div class="mb-3">
                    <label class="form-label">Title</label>
                    <input type="text" class="form-control" id="titleInput" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Link</label>
                    <input type="url" class="form-control" id="linkInput" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Alias</label>
                    <input type="text" class="form-control" id="iconInput" required>
                    <small class="text-muted">Example: Home becomes HO</small>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- Context Menu -->
<div id="contextMenu" class="dropdown-menu shadow">
    <button class="dropdown-item" id="openTab">Open in New Tab</button>
    <button class="dropdown-item" id="openIncognito">Open in Incognito</button>
    <div class="dropdown-divider"></div>
    <button class="dropdown-item" id="editItem">Edit</button>
    <button class="dropdown-item text-danger" id="deleteItem">Delete</button>
</div>

<script>
    $(document).ready(function () {
        let $currentCard = null;

        // ðŸ”¹ Tombol Tambah â†’ selalu reset ke mode Add
        $("[data-bs-target='#itemModal']").on("click", function () {
            $currentCard = null;
            $("#itemForm")[0].reset();
        });
        // Tambah/Edit Submit
        $("#itemForm").on("submit", async function (e) {
            e.preventDefault();
            const id = "launcher-" + Date.now();
            console.log(id)
            const title = $("#titleInput").val();
            const link = $("#linkInput").val();
            const icon = $("#iconInput").val();
            //alert(title)

            if ($currentCard) {
                // Edit existing card.
                //alert('sdsdfd ' + title)
                $currentCard.attr("data-title", title);
                $currentCard.attr("data-link", link);
                $currentCard.attr("data-icon", icon);
                $currentCard.find("a").attr("href", link);
                $currentCard.find("i").text(icon);
                $currentCard.find("h6").text(title);
            } else {
                // Add new card
                const newCard = $(`
                    <div class="col-6 col-md-3 col-lg-2 dashboard-card" id="${id}" data-title="${title}" data-link="${link}" data-icon="${icon}"
                    draggable="true" ondragstart="dragstartHandler(event)"
                    ondrop="dropHandler(event)" ondragover="dragoverHandler(event)"
                    >
                        <a href="${link}" class="text-decoration-none">
                            <div class="card text-center h-100 border-0 shadow-sm">
                                <div class="card-body">
                                    <i class="display-4 text-danger">${icon}</i>
                                    <h6 class="mt-3 text-dark">${title}</h6>
                                </div>
                            </div>
                        </a>
                    </div>
                `);
                $("#dashboardGrid").append(newCard);
            }

            //$("#itemForm")[0].reset();
            $("#itemModal").modal("hide");
            //$currentCard = null;

            await saveLinksToServer()
        });

        // Klik kanan pada card
        $(document).on("contextmenu", ".dashboard-card", function (e) {
            e.preventDefault();
            $currentCard = $(this);

            $("#contextMenu")
                .css({ top: e.pageY, left: e.pageX })
                .show();
        });

        // Klik di luar -> tutup menu
        $(document).click(function () {
            $("#contextMenu").hide();
        });

        // Menu actions
        $("#openTab").click(function () {
            const link = $currentCard.data("link");
            window.open(link, "_blank");
        });

        $("#openIncognito").click(function () {
            const link = $currentCard.data("link");
            alert("This feature has not been implemented yet.");
        });

        $("#editItem").click(function () {
            $("#titleInput").val($currentCard.attr("data-title"));
            $("#linkInput").val($currentCard.attr("data-link"));
            $("#iconInput").val($currentCard.attr("data-icon"));
            $("#itemModal").modal("show");
        });

        $("#deleteItem").click(async function () {
            $currentCard.remove();
            $currentCard = null;
            await saveLinksToServer();
        });
    });

    // Simpan data ke backend
    async function saveLinksToServer() {
        const launcher = [];
        $(".dashboard-card").each(function () {
            //alert($(this).data("title"))
            console.log($(this).attr("id"))
            launcher.push({
                id: $(this).attr("id"),
                url: $(this).data("link"),
                title: $(this).data("title"),
                icon: $(this).data("icon")
            });
        });

        console.log(launcher)
        fetch("/launchers/save", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ launcher })
        })
            .then(res => res.json())
            .then(data => {
                console.log("Data stored:", data);
            })
            .catch(err => {
                console.error("Failed to save:", err);
            });
    }

    function dragstartHandler(ev) {
        ev.dataTransfer.setData("text", ev.currentTarget.id);
    }

    function dragoverHandler(ev) {
        ev.preventDefault();
    }

    async function dropHandler(ev) {
        ev.preventDefault();
        const draggedId = ev.dataTransfer.getData("text");
        const draggedEl = $("#" + draggedId);

        const targetId = ev.currentTarget.id;
        const targetEl = $("#" + targetId);

        if (draggedEl !== targetEl) {
            let temp = {
                title: targetEl.attr("data-title"),
                link: targetEl.attr("data-link"),
                icon: targetEl.attr("data-icon"),
            }

            targetEl.attr("data-title", draggedEl.attr("data-title"));
            targetEl.attr("data-link", draggedEl.attr("data-link"));
            targetEl.attr("data-icon", draggedEl.attr("data-icon"));
            targetEl.find("a").attr("href", draggedEl.attr("data-link"));
            targetEl.find("i").text(draggedEl.attr("data-icon"));
            targetEl.find("h6").text(draggedEl.attr("data-title"));

            draggedEl.attr("data-title", temp.title);
            draggedEl.attr("data-link", temp.link);
            draggedEl.attr("data-icon", temp.icon);
            draggedEl.find("a").attr("href", temp.link);
            draggedEl.find("i").text(temp.icon);
            draggedEl.find("h6").text(temp.title);

            await saveLinksToServer();
        }
    }


</script>